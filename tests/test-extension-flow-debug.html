<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extension Flow Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .debug-output {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        .field-simulation {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f9f9f9;
        }

        .field-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }

        .field-name-input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 150px;
        }

        .field-last-result {
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 3px;
            min-width: 100px;
        }

        .result-text {
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Extension Flow Debug Test</h1>
        <p>This test simulates the complete extension flow to identify where field updates are failing.</p>

        <div class="section">
            <h3>Issue Analysis</h3>
            <div id="issueAnalysis" class="debug-output"></div>
        </div>

        <div class="section">
            <h3>1. Simulate User Fields</h3>
            <div class="field-simulation">
                <div class="field-item">
                    <input type="text" class="field-name-input" value="Is Crazy" readonly>
                    <div class="field-last-result">
                        <div class="result-text">No result yet</div>
                    </div>
                </div>
                <div class="field-item">
                    <input type="text" class="field-name-input" value="Bullish on BTC" readonly>
                    <div class="field-last-result">
                        <div class="result-text">No result yet</div>
                    </div>
                </div>
            </div>
            <button onclick="testComplete()">Run Complete Test</button>
            <div id="testResult" class="debug-output"></div>
        </div>
    </div>

    <script>
        function sanitizeFieldName(friendlyName) {
            if (!friendlyName) return 'unnamed_field';
            return friendlyName.toLowerCase()
                .replace(/[^a-z0-9_]/g, '_')
                .replace(/^_+|_+$/g, '')
                .replace(/_+/g, '_') || 'unnamed_field';
        }

        function simulateFieldUpdate(fieldName, result) {
            const fieldItems = document.querySelectorAll('.field-item');
            let found = false;

            fieldItems.forEach((item, index) => {
                const nameInput = item.querySelector('.field-name-input');
                if (nameInput) {
                    const fieldValue = nameInput.value;
                    const sanitizedFieldValue = sanitizeFieldName(fieldValue);

                    if (sanitizedFieldValue === fieldName) {
                        found = true;
                        const resultContainer = item.querySelector('.field-last-result');
                        const resultText = resultContainer?.querySelector('.result-text');

                        if (resultContainer && resultText) {
                            const formattedResult = `${result.result ? 'TRUE' : 'FALSE'} (${Math.round((result.probability || 0) * 100)}%)`;
                            resultText.innerHTML = formattedResult;
                            resultContainer.className = `field-last-result ${result.result ? 'success' : 'error'}`;
                        }
                    }
                }
            });

            return found;
        }

        function testComplete() {
            let result = "=== COMPLETE EXTENSION FLOW TEST ===\n\n";

            // Test the exact user case
            const llmResponse = {
                "is_crazy": [false, 0.95],
                "bullish_on_btc": [false, 0.98],
                "reason": "Analysis complete"
            };

            result += "1. User configured fields:\n";
            result += "   - 'Is Crazy' ‚Üí sanitizes to 'is_crazy'\n";
            result += "   - 'Bullish on BTC' ‚Üí sanitizes to 'bullish_on_btc'\n\n";

            result += "2. LLM returns:\n";
            Object.entries(llmResponse).forEach(([fieldName, fieldData]) => {
                if (fieldName !== 'reason') {
                    result += `   - "${fieldName}": ${JSON.stringify(fieldData)}\n`;
                }
            });

            result += "\n3. Testing field updates:\n";
            let successCount = 0;
            Object.entries(llmResponse).forEach(([fieldName, fieldData]) => {
                if (fieldName === 'reason') return;

                if (Array.isArray(fieldData) && fieldData.length >= 1) {
                    const testResult = { result: fieldData[0], probability: fieldData[1] };
                    const success = simulateFieldUpdate(fieldName, testResult);
                    result += `   - "${fieldName}": ${success ? 'SUCCESS ‚úì' : 'FAILED ‚ùå'}\n`;
                    if (success) successCount++;
                }
            });

            result += `\n4. Results: ${successCount}/2 fields updated successfully\n\n`;

            if (successCount === 2) {
                result += "üéâ TEST PASSED - Field matching works!\n\n";
                result += "Since simulation works, real issue is likely:\n";
                result += "- LLM response not reaching popup\n";
                result += "- Message passing broken\n";
                result += "- Popup DOM timing issues\n\n";
                result += "Check browser console for:\n";
                result += "- '=== LLM RESULTS DEBUG ===' messages\n";
                result += "- '=== POPUP CAPTURE RESULTS DEBUG ===' messages\n";
                result += "- Any error messages\n";
                document.getElementById('testResult').className = 'debug-output success';
            } else {
                result += "‚ùå TEST FAILED - Field matching broken\n";
                result += "Fix field matching logic first!";
                document.getElementById('testResult').className = 'debug-output error';
            }

            document.getElementById('testResult').textContent = result;
        }

        function analyzeIssue() {
            let analysis = "DIAGNOSIS: Extension shows 'No field evaluations'\n\n";
            analysis += "Most likely causes:\n\n";
            analysis += "1. MESSAGE NOT REACHING POPUP (80% likely)\n";
            analysis += "   - Background sends 'captureResults' but popup doesn't receive\n";
            analysis += "   - Popup closed when message sent\n";
            analysis += "   - Chrome extension message system issue\n\n";
            analysis += "2. LLM RESPONSE PARSING ISSUE (15% likely)\n";
            analysis += "   - JSON parsing fails\n";
            analysis += "   - Response format unexpected\n";
            analysis += "   - No field results extracted\n\n";
            analysis += "3. FIELD MATCHING ISSUE (5% likely)\n";
            analysis += "   - Field names don't match\n";
            analysis += "   - DOM elements missing\n\n";
            analysis += "TO DEBUG:\n";
            analysis += "1. Run manual LLM capture with popup open\n";
            analysis += "2. Check console for debug messages\n";
            analysis += "3. Look for any errors or missing logs\n";

            document.getElementById('issueAnalysis').textContent = analysis;
        }

        window.onload = function () {
            analyzeIssue();
        };
    </script>
</body>

</html>