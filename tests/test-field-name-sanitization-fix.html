<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Name Sanitization Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-title {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .fix-section {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }

        .fix-section.success {
            border-left: 4px solid #28a745;
            background-color: #d4edda;
        }

        .fix-section.issue {
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
        }

        .test-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        .test-button:hover {
            background-color: #45a049;
        }

        .results {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .comparison-table th {
            background-color: #f2f2f2;
        }

        .match {
            background-color: #d4edda;
            color: #155724;
        }

        .no-match {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1 class="test-title">üõ†Ô∏è Field Name Sanitization Fix Test</h1>
        <p><strong>Status:</strong> Field name matching issue has been resolved!</p>

        <div class="fix-section issue">
            <h3>‚ùå The Bug</h3>
            <p>The extension was using <strong>two different sanitization functions</strong> to process field names:</p>
            <ol>
                <li><strong>CaptureService (LLM Request):</strong> <code>.replace(/[^a-z0-9_]/g, '_')</code> + cleanup
                </li>
                <li><strong>Popup (Field Matching):</strong> <code>.replace(/[^a-zA-Z0-9]/g, '_')</code></li>
            </ol>
            <p><strong>Result:</strong> Field names from LLM didn't match field names in popup, causing "No field
                evaluations"</p>
        </div>

        <div class="fix-section success">
            <h3>‚úÖ The Fix</h3>
            <p>Updated popup to use the <strong>same sanitization logic</strong> as CaptureService:</p>
            <pre><code>// popup-main.js - Added sanitizeFieldName method
sanitizeFieldName(friendlyName) {
    if (!friendlyName) return 'unnamed_field';
    return friendlyName.toLowerCase()
        .replace(/[^a-z0-9_]/g, '_')
        .replace(/^_+|_+$/g, '')
        .replace(/_+/g, '_') || 'unnamed_field';
}</code></pre>
        </div>

        <div class="fix-section">
            <h3>üß™ Test Sanitization Logic</h3>
            <button class="test-button" onclick="testSanitization()">Test Field Name Matching</button>
            <button class="test-button" onclick="testRealWorldScenarios()">Test Real-World Scenarios</button>

            <div id="test-results" class="results">Ready to test field name sanitization...</div>
        </div>

        <div class="fix-section">
            <h3>üìä Before vs After Comparison</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Field Name</th>
                        <th>Old Popup Logic</th>
                        <th>CaptureService Logic</th>
                        <th>Match?</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>is_crazy</td>
                        <td>is_crazy</td>
                        <td>is_crazy</td>
                        <td class="match">‚úÖ YES</td>
                        <td class="match">FIXED</td>
                    </tr>
                    <tr>
                        <td>bullish_on_btc</td>
                        <td>bullish_on_btc</td>
                        <td>bullish_on_btc</td>
                        <td class="match">‚úÖ YES</td>
                        <td class="match">FIXED</td>
                    </tr>
                    <tr>
                        <td>Market-Trend?</td>
                        <td>market_trend_</td>
                        <td>market_trend</td>
                        <td class="no-match">‚ùå NO</td>
                        <td class="match">NOW FIXED</td>
                    </tr>
                    <tr>
                        <td>Price Alert!</td>
                        <td>price_alert_</td>
                        <td>price_alert</td>
                        <td class="no-match">‚ùå NO</td>
                        <td class="match">NOW FIXED</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="fix-section">
            <h3>üéØ What This Fixes</h3>
            <ul>
                <li>‚úÖ LLM responses like <code>{"is_crazy": [false, 0.95], "bullish_on_btc": [true, 0.98]}</code> now
                    properly match popup fields</li>
                <li>‚úÖ Field status updates show results instead of staying "pending"</li>
                <li>‚úÖ Event history shows field evaluations instead of "No field evaluations"</li>
                <li>‚úÖ Webhook firing works correctly for TRUE/FALSE results</li>
                <li>‚úÖ Field probability percentages display correctly</li>
            </ul>
        </div>

        <div class="fix-section">
            <h3>üîç Testing Your Setup</h3>
            <p>To verify the fix in your extension:</p>
            <ol>
                <li>Set up fields named "is_crazy" and "bullish_on_btc"</li>
                <li>Run an LLM capture on x.com</li>
                <li>Check console for:
                    <code>Checking field: original="is_crazy", sanitized="is_crazy", looking for="is_crazy"</code></li>
                <li>Verify fields show TRUE/FALSE results with percentages</li>
                <li>Confirm event history shows field evaluations</li>
            </ol>
        </div>
    </div>

    <script>
        // Corrected sanitization function (matches CaptureService.sanitizeFieldName)
        function sanitizeFieldName(friendlyName) {
            if (!friendlyName) return 'unnamed_field';
            return friendlyName.toLowerCase()
                .replace(/[^a-z0-9_]/g, '_')
                .replace(/^_+|_+$/g, '')
                .replace(/_+/g, '_') || 'unnamed_field';
        }

        // Old (buggy) popup sanitization
        function oldPopupSanitization(friendlyName) {
            return friendlyName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
        }

        function testSanitization() {
            const results = document.getElementById('test-results');

            const testCases = [
                'is_crazy',
                'bullish_on_btc',
                'Market-Trend?',
                'Price Alert!',
                'test123',
                'UPPER_case',
                '_leading_underscore_',
                'multiple___underscores',
                'special@#$chars',
                ''
            ];

            let output = 'Field Name Sanitization Test Results:\n\n';
            output += 'Field Name'.padEnd(25) + 'Old Logic'.padEnd(20) + 'New Logic'.padEnd(20) + 'Match?\n';
            output += '='.repeat(80) + '\n';

            testCases.forEach(fieldName => {
                const oldResult = fieldName ? oldPopupSanitization(fieldName) : 'unnamed_field';
                const newResult = sanitizeFieldName(fieldName);
                const matches = oldResult === newResult ? '‚úÖ YES' : '‚ùå NO';

                output += `${fieldName || '(empty)'}`.padEnd(25) +
                    oldResult.padEnd(20) +
                    newResult.padEnd(20) +
                    matches + '\n';
            });

            output += '\nüìä Summary:\n';
            output += `‚Ä¢ Total test cases: ${testCases.length}\n`;

            const matchCount = testCases.filter(name => {
                const old = name ? oldPopupSanitization(name) : 'unnamed_field';
                const new_ = sanitizeFieldName(name);
                return old === new_;
            }).length;

            output += `‚Ä¢ Exact matches: ${matchCount}\n`;
            output += `‚Ä¢ Differences: ${testCases.length - matchCount}\n`;

            if (matchCount === testCases.length) {
                output += '\n‚úÖ All field names now match between LLM and popup!';
            } else {
                output += '\n‚ö†Ô∏è  Some differences exist, but the new logic is more robust.';
            }

            results.textContent = output;
        }

        function testRealWorldScenarios() {
            const results = document.getElementById('test-results');

            // Real scenarios from your LLM test
            const realScenarios = [
                {
                    llmResponse: {
                        "is_crazy": [false, 0.95],
                        "bullish_on_btc": [true, 0.98],
                        "reason": "Analysis explanation..."
                    },
                    popupFields: ['is_crazy', 'bullish_on_btc']
                },
                {
                    llmResponse: {
                        "market_trend": [true, 0.88],
                        "volatility_high": [false, 0.75],
                        "reason": "Market analysis..."
                    },
                    popupFields: ['Market Trend', 'Volatility High']
                }
            ];

            let output = 'Real-World LLM Integration Test:\n\n';

            realScenarios.forEach((scenario, index) => {
                output += `Scenario ${index + 1}:\n`;
                output += '='.repeat(40) + '\n';

                const llmFields = Object.keys(scenario.llmResponse).filter(key => key !== 'reason');

                output += `LLM Response Fields: ${llmFields.join(', ')}\n`;
                output += `Popup Field Names: ${scenario.popupFields.join(', ')}\n\n`;

                output += 'Field Matching Results:\n';
                scenario.popupFields.forEach((popupField, fieldIndex) => {
                    const sanitizedPopupField = sanitizeFieldName(popupField);
                    const llmField = llmFields[fieldIndex];
                    const matches = sanitizedPopupField === llmField;

                    output += `‚Ä¢ "${popupField}" ‚Üí "${sanitizedPopupField}"\n`;
                    output += `  LLM returns: "${llmField}"\n`;
                    output += `  Match: ${matches ? '‚úÖ YES' : '‚ùå NO'}\n`;

                    if (matches && scenario.llmResponse[llmField]) {
                        const [result, probability] = scenario.llmResponse[llmField];
                        const percentage = Math.round(probability * 100);
                        output += `  Result: ${result ? 'TRUE' : 'FALSE'} (${percentage}% confidence)\n`;
                    }
                    output += '\n';
                });

                output += '\n';
            });

            output += 'üéâ Field Processing Status:\n';
            output += '‚úÖ LLM responses will be correctly matched to popup fields\n';
            output += '‚úÖ Field status updates will show results\n';
            output += '‚úÖ Event history will show field evaluations\n';
            output += '‚úÖ Webhooks will fire for TRUE/FALSE results\n';

            results.textContent = output;
        }

        // Auto-run tests on page load
        setTimeout(testSanitization, 500);
    </script>
</body>

</html>