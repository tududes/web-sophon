<!DOCTYPE html>
<html>

<head>
    <title>Debug LLM Configuration</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
        }

        .config-section {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }

        .key {
            font-weight: bold;
            color: #666;
        }

        .value {
            color: #333;
        }

        .empty {
            color: #999;
            font-style: italic;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }

        .debug-button {
            padding: 10px;
            margin: 5px;
        }
    </style>
</head>

<body>
    <h1>🔍 LLM Configuration Debug</h1>

    <div>
        <button class="debug-button" onclick="checkAllStorage()">🔍 Check All Storage</button>
        <button class="debug-button" onclick="testCurrentDomain()">🌐 Test Current Domain Config</button>
        <button class="debug-button" onclick="testApiConnection()">🔗 Test API Connection</button>
        <button class="debug-button" onclick="clearLlmConfig()">🗑️ Clear LLM Config</button>
    </div>

    <div id="output"></div>

    <script>
        async function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${timestamp}] ${message}`;
            output.appendChild(div);
            console.log(message);
        }

        async function checkAllStorage() {
            log('=== CHECKING ALL STORAGE ===');

            try {
                const allData = await chrome.storage.local.get();
                log(`Found ${Object.keys(allData).length} storage keys total`);

                // Find LLM-related keys
                const llmKeys = Object.keys(allData).filter(key =>
                    key.includes('llm') || key.includes('Llm')
                );

                log(`Found ${llmKeys.length} LLM-related keys:`);
                llmKeys.forEach(key => {
                    const value = allData[key];
                    if (typeof value === 'object') {
                        log(`  🔑 ${key}:`, 'key');
                        Object.entries(value).forEach(([k, v]) => {
                            if (k === 'apiKey' && v) {
                                log(`    📍 ${k}: ${v.substring(0, 10)}... (${v.length} chars)`, 'value');
                            } else {
                                log(`    📍 ${k}: ${typeof v === 'string' ? v : JSON.stringify(v)}`, 'value');
                            }
                        });
                    } else {
                        log(`  🔑 ${key}: ${value}`, 'key');
                    }
                });

                // Check for domain patterns
                const domainKeys = Object.keys(allData).filter(key => key.includes('_'));
                const domains = new Set();
                domainKeys.forEach(key => {
                    const parts = key.split('_');
                    if (parts.length >= 2) {
                        domains.add(parts.slice(1).join('_'));
                    }
                });

                log(`Found ${domains.size} unique domains:`, 'success');
                Array.from(domains).forEach(domain => {
                    log(`  🌐 ${domain}`, 'value');
                });

            } catch (error) {
                log(`❌ Error checking storage: ${error.message}`, 'error');
            }
        }

        async function testCurrentDomain() {
            log('=== TESTING CURRENT DOMAIN CONFIG ===');

            try {
                // Get current tab to determine domain
                const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
                const url = new URL(tab.url);
                const domain = url.hostname;

                log(`Current domain: ${domain}`, 'success');

                // Check LLM config for this domain
                const configKey = `llmConfig_${domain}`;
                const modeKey = `llmMode_${domain}`;

                const data = await chrome.storage.local.get([configKey, modeKey]);

                log(`LLM Mode (${modeKey}): ${data[modeKey] ? 'ENABLED' : 'DISABLED'}`,
                    data[modeKey] ? 'success' : 'error');

                const config = data[configKey];
                if (config) {
                    log(`LLM Config found for ${domain}:`, 'success');
                    log(`  📍 API URL: ${config.apiUrl || 'NOT SET'}`, config.apiUrl ? 'value' : 'error');
                    log(`  📍 API Key: ${config.apiKey ? config.apiKey.substring(0, 10) + '... (' + config.apiKey.length + ' chars)' : 'NOT SET'}`, config.apiKey ? 'value' : 'error');
                    log(`  📍 Model: ${config.model || 'NOT SET'}`, config.model ? 'value' : 'error');
                    log(`  📍 Temperature: ${config.temperature || 'NOT SET'}`, 'value');
                    log(`  📍 Max Tokens: ${config.maxTokens || 'NOT SET'}`, 'value');

                    if (config.model === 'custom') {
                        log(`  📍 Custom Model: ${config.customModel || 'NOT SET'}`, config.customModel ? 'value' : 'error');
                    }
                } else {
                    log(`❌ No LLM config found for ${domain}`, 'error');
                }

            } catch (error) {
                log(`❌ Error testing domain config: ${error.message}`, 'error');
            }
        }

        async function testApiConnection() {
            log('=== TESTING API CONNECTION ===');

            try {
                // Get current domain config
                const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
                const url = new URL(tab.url);
                const domain = url.hostname;

                const configKey = `llmConfig_${domain}`;
                const data = await chrome.storage.local.get([configKey]);
                const config = data[configKey];

                if (!config || !config.apiUrl || !config.apiKey) {
                    log('❌ Missing API URL or API Key', 'error');
                    return;
                }

                log(`Testing connection to: ${config.apiUrl}`, 'value');
                log(`Using API Key: ${config.apiKey.substring(0, 10)}...`, 'value');

                // Test API connection with minimal request
                const testPayload = {
                    model: config.model === 'custom' ? config.customModel : config.model,
                    messages: [
                        {
                            role: "user",
                            content: "Hello, just testing connection. Please respond with 'OK'."
                        }
                    ],
                    max_tokens: 10,
                    temperature: 0.1,
                    stream: false
                };

                log('Sending test request...', 'value');

                const response = await fetch(config.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify(testPayload)
                });

                log(`Response status: ${response.status} ${response.statusText}`,
                    response.ok ? 'success' : 'error');

                const responseText = await response.text();
                log(`Response body: ${responseText.substring(0, 200)}${responseText.length > 200 ? '...' : ''}`,
                    response.ok ? 'success' : 'error');

                if (response.ok) {
                    log('✅ API connection successful!', 'success');
                } else {
                    log('❌ API connection failed', 'error');
                }

            } catch (error) {
                log(`❌ Error testing API connection: ${error.message}`, 'error');
            }
        }

        async function clearLlmConfig() {
            if (!confirm('Clear LLM configuration for current domain?')) return;

            log('=== CLEARING LLM CONFIG ===');

            try {
                const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
                const url = new URL(tab.url);
                const domain = url.hostname;

                const configKey = `llmConfig_${domain}`;
                const modeKey = `llmMode_${domain}`;

                await chrome.storage.local.remove([configKey, modeKey]);
                log(`✅ Cleared LLM config for ${domain}`, 'success');

            } catch (error) {
                log(`❌ Error clearing config: ${error.message}`, 'error');
            }
        }

        // Auto-run check on load
        window.addEventListener('load', () => {
            checkAllStorage();
            setTimeout(testCurrentDomain, 1000);
        });
    </script>
</body>

</html>