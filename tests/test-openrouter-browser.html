<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenRouter InternVL3 14B Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-title {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .config-section {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .test-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        .test-button:hover {
            background-color: #45a049;
        }

        .test-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .test-button.danger {
            background-color: #f44336;
        }

        .test-button.danger:hover {
            background-color: #da190b;
        }

        .results {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        .field-result {
            background-color: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }

        .field-result.success {
            background-color: #d4edda;
            border-color: #28a745;
        }

        .field-result.failure {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .image-preview {
            max-width: 300px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .status-icon {
            font-size: 18px;
            margin-right: 8px;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1 class="test-title">üöÄ OpenRouter InternVL3 14B Integration Test</h1>
        <p>Test your WebSophon LLM integration with OpenRouter's free vision model</p>

        <div class="config-section">
            <h3>üîß Configuration</h3>

            <div class="form-group">
                <label for="api-key">OpenRouter API Key:</label>
                <input type="password" id="api-key"
                    value="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"
                    placeholder="sk-or-v1-...">
            </div>

            <div class="form-group">
                <label for="model">Model:</label>
                <select id="model">
                    <option value="opengvlab/internvl3-14b:free" selected>OpenGVLab InternVL3 14B (Free)</option>
                    <option value="opengvlab/internvl3-2b:free">OpenGVLab InternVL3 2B (Free)</option>
                    <option value="qwen/qwen2.5-vl-72b-instruct:free">Qwen 2.5 VL 72B (Free)</option>
                    <option value="google/gemini-2.5-pro-exp-03-25">Google Gemini 2.5 Pro Exp (Free)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="domain">Domain:</label>
                <input type="text" id="domain" value="x.com" placeholder="x.com">
            </div>
        </div>

        <div class="config-section">
            <h3>üìä Field Configuration</h3>

            <div class="form-group">
                <label for="field1-name">Field 1 Name:</label>
                <input type="text" id="field1-name" value="is_crazy" placeholder="is_crazy">
            </div>

            <div class="form-group">
                <label for="field1-criteria">Field 1 Criteria:</label>
                <textarea id="field1-criteria" rows="2"
                    placeholder="Evaluation criteria...">Let me know if Elon is behaing erraitc with his latest tweet at the top of the page</textarea>
            </div>

            <div class="form-group">
                <label for="field2-name">Field 2 Name:</label>
                <input type="text" id="field2-name" value="bullish_on_btc" placeholder="bullish_on_btc">
            </div>

            <div class="form-group">
                <label for="field2-criteria">Field 2 Criteria:</label>
                <textarea id="field2-criteria" rows="2"
                    placeholder="Evaluation criteria...">Elon mentioned BTC or any other crypto</textarea>
            </div>
        </div>

        <div class="config-section">
            <h3>üì∑ Screenshot Upload</h3>

            <div class="form-group">
                <label for="screenshot">Select Screenshot:</label>
                <input type="file" id="screenshot" accept="image/*">
            </div>

            <div id="image-preview"></div>
        </div>

        <div class="config-section">
            <button class="test-button" onclick="runTest()" id="test-btn">
                üß™ Run OpenRouter Test
            </button>

            <button class="test-button danger" onclick="clearResults()">
                üóëÔ∏è Clear Results
            </button>
        </div>

        <div class="loading" id="loading">
            <div>üîÑ Testing OpenRouter Integration...</div>
            <div style="margin-top: 10px; font-size: 14px;">This may take 10-30 seconds</div>
        </div>

        <div id="results-container"></div>
    </div>

    <script>
        // Configuration from WebSophon
        const CONFIG = {
            apiUrl: 'https://openrouter.ai/api/v1/chat/completions'
        };

        // System prompt template from WebSophon
        function generateSystemPrompt(fields) {
            return `Your job is very important and the results you provide will serve as a gatekeeper for actions taken in an automated system. You will behave as a highly accurate frame-by-frame screenshot processing engine, where you will be passed an image and a set of one or more fields accompanied by a value for each which is the key criteria necessary to evaluate for a boolean true or false value according to your image analysis.

You will respond in pure parseable JSON string from start to finish without any markdown containing all original field(s), each accompanied by an array of the resulting boolean, and resulting probability represented by a floating point number between 0 and 1 that your analysis resulted in a boolean that is 100% correct according to the screenshot. Then at the end of the json response, you will append an additional field named "reason" which will contain a brief explanation of what you saw in the image and the state of the screenshot.

Here are the fields and their criteria for evaluation:
${JSON.stringify(fields, null, 2)}`;
        }

        // Enhanced JSON parsing logic (from the fixes)
        function parseMarkdownJSON(content) {
            console.log('Parsing LLM response content...');

            // First, try to extract JSON from markdown code blocks if present
            let jsonContent = content;

            // Check if content is wrapped in markdown code blocks
            const codeBlockRegex = /```(?:json)?\s*([\s\S]*?)\s*```/;
            const codeBlockMatch = content.match(codeBlockRegex);
            if (codeBlockMatch) {
                jsonContent = codeBlockMatch[1].trim();
                console.log('‚úÖ Extracted JSON from markdown code blocks');
            }

            // If no code blocks, try to find JSON object directly
            if (!codeBlockMatch) {
                const jsonObjectRegex = /\{[\s\S]*\}/;
                const jsonMatch = content.match(jsonObjectRegex);
                if (jsonMatch) {
                    jsonContent = jsonMatch[0];
                    console.log('‚úÖ Extracted JSON object from content');
                }
            }

            try {
                const responseData = JSON.parse(jsonContent);
                console.log('‚úÖ Successfully parsed JSON response');
                return {
                    success: true,
                    data: responseData,
                    extractedJson: jsonContent
                };
            } catch (contentParseError) {
                console.error('‚ùå Failed to parse LLM content as JSON:', contentParseError.message);
                return {
                    success: false,
                    error: 'Failed to parse LLM response as JSON',
                    raw_content: content,
                    attempted_json: jsonContent,
                    parse_error: contentParseError.message
                };
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Handle file upload preview
        document.getElementById('screenshot').addEventListener('change', function (e) {
            const file = e.target.files[0];
            const preview = document.getElementById('image-preview');

            if (file) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'image-preview';
                img.alt = 'Screenshot preview';

                preview.innerHTML = '';
                preview.appendChild(img);
            } else {
                preview.innerHTML = '';
            }
        });

        // Main test function
        async function runTest() {
            const resultsContainer = document.getElementById('results-container');
            const loading = document.getElementById('loading');
            const testBtn = document.getElementById('test-btn');

            // Clear previous results
            resultsContainer.innerHTML = '';

            try {
                // Validate inputs
                const apiKey = document.getElementById('api-key').value.trim();
                const model = document.getElementById('model').value;
                const domain = document.getElementById('domain').value.trim();
                const screenshotFile = document.getElementById('screenshot').files[0];

                if (!apiKey) {
                    throw new Error('API Key is required');
                }

                if (!screenshotFile) {
                    throw new Error('Please select a screenshot file');
                }

                // Get field configurations
                const fields = [];

                const field1Name = document.getElementById('field1-name').value.trim();
                const field1Criteria = document.getElementById('field1-criteria').value.trim();
                if (field1Name && field1Criteria) {
                    fields.push({ name: field1Name, criteria: field1Criteria });
                }

                const field2Name = document.getElementById('field2-name').value.trim();
                const field2Criteria = document.getElementById('field2-criteria').value.trim();
                if (field2Name && field2Criteria) {
                    fields.push({ name: field2Name, criteria: field2Criteria });
                }

                if (fields.length === 0) {
                    throw new Error('At least one field configuration is required');
                }

                // Show loading
                loading.classList.add('show');
                testBtn.disabled = true;

                // Convert image to base64
                const base64Image = await fileToBase64(screenshotFile);
                const imageSize = Math.round(base64Image.length / 1024);

                addResult(`üì∑ Screenshot: ${screenshotFile.name} (${imageSize}KB)`);
                addResult(`ü§ñ Model: ${model}`);
                addResult(`üìä Fields: ${fields.length}`);
                addResult('');

                // Generate system prompt
                const systemPrompt = generateSystemPrompt(fields);
                addResult('üìù System Prompt Generated');
                addResult(`Preview: ${systemPrompt.substring(0, 100)}...`);
                addResult('');

                // Prepare API request
                const requestPayload = {
                    model: model,
                    messages: [
                        {
                            role: 'system',
                            content: systemPrompt
                        },
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: 'Please analyze this screenshot according to the field criteria provided in the system prompt.'
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 1000,
                    temperature: 0.1
                };

                addResult('üîß Request Prepared');
                addResult(`üìä Payload Size: ${Math.round(JSON.stringify(requestPayload).length / 1024)}KB`);
                addResult('');

                // Send request to OpenRouter
                addResult('üåê Sending request to OpenRouter...');
                const startTime = Date.now();

                const response = await fetch(CONFIG.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': 'https://github.com/chrisk/tv-eyes',
                        'X-Title': 'WebSophon - Screenshot Analysis'
                    },
                    body: JSON.stringify(requestPayload)
                });

                const responseTime = Date.now() - startTime;
                addResult(`‚è±Ô∏è Response received in ${responseTime}ms`);

                // Handle response
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`OpenRouter API Error ${response.status}: ${response.statusText}\n${errorText}`);
                }

                const responseData = await response.text();
                addResult('‚úÖ Response received successfully');
                addResult('');

                // Parse the response
                let llmData;
                try {
                    llmData = JSON.parse(responseData);
                } catch (error) {
                    throw new Error(`Failed to parse OpenRouter response: ${error.message}`);
                }

                addResult(`üìã Provider: ${llmData.provider || 'Unknown'}`);
                addResult(`üéØ Model used: ${llmData.model || model}`);
                addResult(`üí∞ Token usage: ${llmData.usage ? `${llmData.usage.total_tokens} total` : 'Not provided'}`);
                addResult('');

                // Extract content from response
                let content = '';
                if (llmData.choices && llmData.choices[0] && llmData.choices[0].message) {
                    content = llmData.choices[0].message.content;
                } else {
                    throw new Error('Unexpected OpenRouter response format');
                }

                addResult('üìù Raw LLM Content:');
                addResult('-------------------');
                addResult(content);
                addResult('-------------------');
                addResult('');

                // Parse the field results using enhanced parsing
                const parseResult = parseMarkdownJSON(content);

                if (!parseResult.success) {
                    throw new Error(`Failed to parse field results: ${parseResult.error}`);
                }

                const fieldResults = parseResult.data;
                addResult('‚úÖ Field results parsed successfully');
                addResult('');

                // Analyze field results
                addResult('üìä FIELD ANALYSIS RESULTS');
                addResult('==========================');

                let fieldsProcessed = 0;
                const processedFields = [];

                for (const [fieldName, fieldResult] of Object.entries(fieldResults)) {
                    if (fieldName !== 'reason' && Array.isArray(fieldResult) && fieldResult.length >= 1) {
                        fieldsProcessed++;
                        const result = fieldResult[0]; // boolean result
                        const probability = fieldResult.length > 1 ? fieldResult[1] : null;
                        const percentage = probability ? Math.round(probability * 100) : null;

                        processedFields.push({
                            name: fieldName,
                            result: result,
                            probability: probability,
                            percentage: percentage
                        });

                        const statusIcon = result ? 'üü¢' : 'üî¥';
                        const confidenceText = percentage ? ` (${percentage}% confidence)` : '';
                        addResult(`${statusIcon} ${fieldName}: ${result ? 'TRUE' : 'FALSE'}${confidenceText}`);

                        // Check field configuration
                        const fieldConfig = fields.find(f => f.name === fieldName);
                        if (fieldConfig) {
                            addResult(`   üìã Criteria: "${fieldConfig.criteria}"`);
                        } else {
                            addResult(`   ‚ö†Ô∏è No field configuration found for "${fieldName}"`);
                        }
                        addResult('');

                        // Create field result card
                        createFieldResultCard(fieldName, result, percentage, fieldConfig);
                    }
                }

                // Show reason
                if (fieldResults.reason) {
                    addResult('üí≠ ANALYSIS REASONING:');
                    addResult(fieldResults.reason);
                    addResult('');
                }

                // Summary
                addResult('üìà SUMMARY');
                addResult('===========');
                addResult(`‚úÖ Fields processed: ${fieldsProcessed}`);
                addResult(`‚è±Ô∏è Total time: ${responseTime}ms`);
                addResult(`ü§ñ Model: ${model} (Nineteen on Bittensor)`);
                addResult(`üí∞ Cost: FREE (${llmData.usage ? llmData.usage.total_tokens + ' tokens' : 'N/A'})`);
                addResult('');

                addResult('üéâ OpenRouter Integration Test SUCCESSFUL!');

            } catch (error) {
                addResult(`‚ùå Test failed: ${error.message}`);
                console.error('Test error:', error);
            } finally {
                // Hide loading
                loading.classList.remove('show');
                testBtn.disabled = false;
            }
        }

        function createFieldResultCard(fieldName, result, percentage, fieldConfig) {
            const resultsContainer = document.getElementById('results-container');

            const card = document.createElement('div');
            card.className = `field-result ${result ? 'success' : 'failure'}`;

            const statusIcon = result ? 'üü¢' : 'üî¥';
            const confidenceText = percentage ? ` (${percentage}% confidence)` : '';

            card.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 8px;">
                    <span class="status-icon">${statusIcon}</span>
                    ${fieldName}: ${result ? 'TRUE' : 'FALSE'}${confidenceText}
                </div>
                <div style="font-size: 14px; color: #666;">
                    ${fieldConfig ? `Criteria: "${fieldConfig.criteria}"` : 'No criteria found'}
                </div>
                <div style="margin-top: 8px; font-size: 12px;">
                    Webhook would ${result ? 'FIRE' : 'NOT FIRE'} for this result
                </div>
            `;

            resultsContainer.appendChild(card);
        }

        function addResult(text) {
            const resultsContainer = document.getElementById('results-container');

            let resultsDiv = document.getElementById('test-results');
            if (!resultsDiv) {
                resultsDiv = document.createElement('div');
                resultsDiv.id = 'test-results';
                resultsDiv.className = 'results';
                resultsContainer.appendChild(resultsDiv);
            }

            resultsDiv.textContent += text + '\n';
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results-container').innerHTML = '';
        }

        // Initialize
        console.log('OpenRouter Integration Test loaded');
        console.log('Place your screenshot file: websophon-screenshot-2025-06-13-22-06-31.png');
    </script>
</body>

</html>